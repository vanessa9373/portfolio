##############################################################################
# Deploy Application Playbook
#
# Pulls and deploys the application container with zero-downtime.
# Uses rolling deployment strategy (one host at a time).
#
# Usage:
#   ansible-playbook playbooks/deploy-app.yml -e "app_version=1.2.3"
#   ansible-playbook playbooks/deploy-app.yml -e "app_version=latest"
##############################################################################
---
- name: Deploy application with zero-downtime
  hosts: webservers
  become: true
  serial: 1  # Rolling deployment â€” one host at a time
  vars:
    app_image: "{{ docker_registry | default('ghcr.io') }}/{{ project_name }}/app"
    app_version: "latest"
    app_port: 8080
    health_check_retries: 10
    health_check_delay: 5

  pre_tasks:
    - name: Print deployment info
      ansible.builtin.debug:
        msg: "Deploying {{ app_image }}:{{ app_version }} to {{ inventory_hostname }}"

    # Drain traffic from this host (remove from load balancer)
    - name: Mark host as draining
      ansible.builtin.file:
        path: /opt/app/maintenance
        state: touch
        mode: "0644"
      tags: [deploy]

    - name: Wait for in-flight requests to complete
      ansible.builtin.pause:
        seconds: 10
      tags: [deploy]

  tasks:
    - name: Pull new application image
      community.docker.docker_image:
        name: "{{ app_image }}"
        tag: "{{ app_version }}"
        source: pull
        force_source: true
      tags: [deploy]

    - name: Stop existing container
      community.docker.docker_container:
        name: "{{ app_name | default('sre-app') }}"
        state: absent
      tags: [deploy]

    - name: Start new container
      community.docker.docker_container:
        name: "{{ app_name | default('sre-app') }}"
        image: "{{ app_image }}:{{ app_version }}"
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ app_port }}:{{ app_port }}"
        env:
          APP_VERSION: "{{ app_version }}"
          ENVIRONMENT: "{{ environment }}"
          NODE_NAME: "{{ inventory_hostname }}"
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:{{ app_port }}/health"]
          interval: 10s
          timeout: 5s
          retries: 3
          start_period: 30s
        log_driver: json-file
        log_options:
          max-size: "50m"
          max-file: "5"
      register: container_result
      tags: [deploy]

    - name: Wait for container to be healthy
      ansible.builtin.uri:
        url: "http://localhost:{{ app_port }}/health"
        return_content: true
      register: health_check
      until: health_check.status == 200
      retries: "{{ health_check_retries }}"
      delay: "{{ health_check_delay }}"
      tags: [deploy]

  post_tasks:
    # Re-enable traffic to this host
    - name: Remove maintenance flag
      ansible.builtin.file:
        path: /opt/app/maintenance
        state: absent
      tags: [deploy]

    - name: Print deployment result
      ansible.builtin.debug:
        msg: |
          Deployed {{ app_image }}:{{ app_version }} on {{ inventory_hostname }}
          Health check: {{ health_check.json | default('OK') }}
      tags: [deploy]
