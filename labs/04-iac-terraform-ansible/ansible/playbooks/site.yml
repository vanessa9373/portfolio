##############################################################################
# Site Playbook — Full infrastructure provisioning
#
# Applies ALL roles to ALL servers in the correct order.
#
# Usage:
#   ansible-playbook playbooks/site.yml
#   ansible-playbook playbooks/site.yml --limit webservers
#   ansible-playbook playbooks/site.yml --tags docker
#   ansible-playbook playbooks/site.yml --check  (dry run)
##############################################################################
---
# ── Phase 1: Base Configuration (ALL servers) ──────────────────────────
- name: Apply base configuration to all servers
  hosts: all
  become: true
  roles:
    - role: common
      tags: [common, base]
    - role: monitoring
      tags: [monitoring]
    - role: hardening
      tags: [hardening, security]

# ── Phase 2: Application Servers ───────────────────────────────────────
- name: Configure application servers
  hosts: webservers
  become: true
  roles:
    - role: docker
      tags: [docker, app]

  post_tasks:
    - name: Verify Docker is running
      ansible.builtin.command: docker info
      register: docker_info
      changed_when: false
      tags: [docker, verify]

    - name: Print Docker version
      ansible.builtin.debug:
        msg: "Docker is running: {{ docker_info.stdout_lines[0] }}"
      tags: [docker, verify]

# ── Phase 3: Verification ─────────────────────────────────────────────
- name: Verify all services are running
  hosts: all
  become: true
  tasks:
    - name: Check Node Exporter
      ansible.builtin.uri:
        url: "http://localhost:9100/metrics"
        return_content: false
      register: node_exporter_check
      failed_when: node_exporter_check.status != 200
      tags: [verify]

    - name: Print verification summary
      ansible.builtin.debug:
        msg: |
          Server {{ inventory_hostname }} configured successfully:
          - Node Exporter: Running (port 9100)
          - Environment: {{ environment }}
      tags: [verify]
