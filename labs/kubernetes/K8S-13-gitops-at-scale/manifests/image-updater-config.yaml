# ArgoCD Image Updater configuration ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-image-updater-config
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-image-updater
data:
  # Registry configuration
  registries.conf: |
    registries:
      - name: ECR
        api_url: https://123456789012.dkr.ecr.us-east-1.amazonaws.com
        prefix: 123456789012.dkr.ecr.us-east-1.amazonaws.com
        credentials: ext:/scripts/ecr-login.sh
        credsexpire: 10h
        default: true

  # Git write-back configuration
  git.commit-message-template: |
    build: update image {{ .AppName }} to {{ .NewImage }}

    Automated image update by ArgoCD Image Updater.
    Application: {{ .AppName }}
    Image: {{ .NewImage }}

  # Polling interval
  applications_api: argocd

  # Log level
  log.level: info
---
# ECR credentials helper script
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-image-updater-ecr-scripts
  namespace: argocd
data:
  ecr-login.sh: |
    #!/bin/sh
    aws ecr get-login-password --region us-east-1
---
# ServiceAccount for Image Updater with IRSA
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-image-updater
  namespace: argocd
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/argocd-image-updater
---
# SSH key secret for git write-back
apiVersion: v1
kind: Secret
metadata:
  name: argocd-image-updater-ssh-key
  namespace: argocd
type: Opaque
stringData:
  sshPrivateKey: |
    # Replace with actual SSH private key for Git write-back
    # This key must have write access to the GitOps repository
    -----BEGIN OPENSSH PRIVATE KEY-----
    REPLACE_WITH_ACTUAL_KEY
    -----END OPENSSH PRIVATE KEY-----
