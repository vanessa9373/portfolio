apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-adapter-config
  namespace: monitoring
  labels:
    app: prometheus-adapter
data:
  config.yaml: |
    # Rules for converting Prometheus metrics to Kubernetes custom metrics API
    rules:
      # Rule 1: HTTP requests per second per pod
      # Used by HPA to scale based on request rate
      - seriesQuery: 'http_requests_total{namespace!="",pod!=""}'
        resources:
          overrides:
            namespace:
              resource: namespace
            pod:
              resource: pod
        name:
          matches: "^(.*)_total$"
          as: "${1}_per_second"
        metricsQuery: 'sum(rate(<<.Series>>{<<.LabelMatchers>>}[2m])) by (<<.GroupBy>>)'

      # Rule 2: Request latency (p99)
      # Can be used by HPA to scale when latency increases
      - seriesQuery: 'http_request_duration_seconds_bucket{namespace!="",pod!=""}'
        resources:
          overrides:
            namespace:
              resource: namespace
            pod:
              resource: pod
        name:
          matches: "^(.*)_bucket$"
          as: "${1}_p99"
        metricsQuery: 'histogram_quantile(0.99, sum(rate(<<.Series>>{<<.LabelMatchers>>}[5m])) by (le, <<.GroupBy>>))'

      # Rule 3: Active connections per pod
      - seriesQuery: 'http_active_connections{namespace!="",pod!=""}'
        resources:
          overrides:
            namespace:
              resource: namespace
            pod:
              resource: pod
        name:
          matches: "^(.*)$"
          as: "${1}"
        metricsQuery: 'sum(<<.Series>>{<<.LabelMatchers>>}) by (<<.GroupBy>>)'

    # External metrics (cluster-wide, not per-pod)
    externalRules:
      # SQS queue depth as external metric
      - seriesQuery: 'aws_sqs_approximate_number_of_messages_visible'
        resources: {}
        name:
          matches: "^(.*)$"
          as: "sqs_messages_visible"
        metricsQuery: 'sum(<<.Series>>{<<.LabelMatchers>>})'

    # Resource rules for core metrics (CPU, memory)
    resourceRules:
      cpu:
        containerQuery: 'sum(rate(container_cpu_usage_seconds_total{<<.LabelMatchers>>,container!=""}[3m])) by (<<.GroupBy>>)'
        nodeQuery: 'sum(rate(container_cpu_usage_seconds_total{<<.LabelMatchers>>,id="/"}[3m])) by (<<.GroupBy>>)'
        resources:
          overrides:
            namespace:
              resource: namespace
            node:
              resource: node
        containerLabel: container
      memory:
        containerQuery: 'sum(container_memory_working_set_bytes{<<.LabelMatchers>>,container!=""}) by (<<.GroupBy>>)'
        nodeQuery: 'sum(container_memory_working_set_bytes{<<.LabelMatchers>>,id="/"}) by (<<.GroupBy>>)'
        resources:
          overrides:
            namespace:
              resource: namespace
            node:
              resource: node
        containerLabel: container
---
# Prometheus Adapter Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus-adapter
  namespace: monitoring
  labels:
    app: prometheus-adapter
spec:
  replicas: 2
  selector:
    matchLabels:
      app: prometheus-adapter
  template:
    metadata:
      labels:
        app: prometheus-adapter
    spec:
      containers:
        - name: prometheus-adapter
          image: registry.k8s.io/prometheus-adapter/prometheus-adapter:v0.11.2
          args:
            - --secure-port=6443
            - --tls-cert-file=/var/run/serving-cert/tls.crt
            - --tls-private-key-file=/var/run/serving-cert/tls.key
            - --cert-dir=/tmp/cert
            - --prometheus-url=http://prometheus-server.monitoring.svc.cluster.local:9090
            - --config=/etc/adapter/config.yaml
            - --logtostderr=true
            - --v=4
          ports:
            - containerPort: 6443
              name: https
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          volumeMounts:
            - name: config
              mountPath: /etc/adapter
              readOnly: true
            - name: serving-cert
              mountPath: /var/run/serving-cert
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: prometheus-adapter-config
        - name: serving-cert
          secret:
            secretName: prometheus-adapter-tls
